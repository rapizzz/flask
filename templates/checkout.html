<!-- checkout.html -->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='checkout.css') }}">
</head>
<body>
    <div class="checkout-container">
        <h2 style="text-align: center">Order</h2>
        <form onsubmit="submitOrder(event)">
            <label for="phoneNumber">Тел:</label>
            <input type="text" id="phoneNumber" name="phoneNumber" required>

            <label for="fullName">ФИО:</label>
            <input type="text" id="fullName" name="fullName" required>

            <label for="address">Адрес НП:</label>
            <!-- Добавлены классы для обработки с помощью JavaScript -->
            <div class="autocomplete-container">
                <input type="text" id="address" name="address" required class="autocomplete-input">
                <div class="autocomplete-items" id="autocomplete-items"></div>
            </div>

            <!-- Cart details table for better layout -->
            <table class="cart-details">
                <thead>
                    <tr>
                        <th style="text-align: center">Товар</th>
                        <th style="text-align: center">Прайс</th>
                        <th style="text-align: center">К-во</th>
{#                        <th>Total</th>#}
                        <th style="text-align: center">Action</th>
                    </tr>
                </thead>
                <tbody id="cart-items">
                </tbody>
            </table>
            <div style="border-radius: 10%; background-color: #2980b9; position: fixed; top: 1%; left: 1%; width: 60px; height: 40px; display: flex; justify-content: center; align-items: center;" class="back">
                <a style="color: white; font-size: 48px; text-decoration: none;" href="/">⟸</a>
            </div>
            <div class="subdiv">
                <button type="submit" onclick="openCheckout()">
                    <span class="total">Order $<span id="cart-total">0.00</span></span>
                </button>
            </div>
        </form>
    </div>
    <div id="usercard"></div>
    <script src="{{ url_for('static', filename='checkout.js') }}"></script>
    <script>
        async function getNovaPostSuggestions(query) {
            const apiKey = "574fbab8b16065351da4de2c094b7088";
            const url = `/novapost/divisions?query=${encodeURIComponent(query)}&limit=5`;

            try {
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json',
                    },
                });

                const data = await response.json();

                if (data.success && data.data.length > 0) {
                    return data.data.map(item => item.name);
                } else {
                    return [];
                }
            } catch (error) {
                console.error('Error fetching data:', error);
                return [];
            }
        }

        const addressInput = document.getElementById('address');
        const autocompleteItems = document.getElementById('autocomplete-items');

        addressInput.addEventListener('input', async function () {
            const inputValue = this.value;

            const suggestions = await getNovaPostSuggestions(inputValue);

            autocompleteItems.innerHTML = '';
            suggestions.forEach(suggestion => {
                const item = document.createElement('div');
                item.classList.add('autocomplete-item');
                item.textContent = suggestion;
                item.addEventListener('click', function () {
                    addressInput.value = suggestion;
                    autocompleteItems.innerHTML = '';
                });
                autocompleteItems.appendChild(item);
            });
        });
    </script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        let tg = window.Telegram.WebApp;

        function openNewWindow(userId, userInfo) {
            const newWindow = window.open('', '_blank');
            newWindow.document.write(`<h3>User ID: ${userId}</h3>`);
            newWindow.document.write(`<h3>User Info: ${userInfo}</h3>`);
        }

        function initializeTelegram() {
            let usercard = document.getElementById("usercard");
            let profName = document.createElement('h3');
            profName.innerText = `${tg.initDataUnsafe.user.first_name} ${tg.initDataUnsafe.user.last_name} ${tg.initDataUnsafe.user.id}`;
            profName.classList.add('user-info');
            usercard.appendChild(profName);


            // Вывод в консоль при установлении соединения с профилем
            console.log('Connection with the user profile established.');

            // Проверка наличия Telegram и открытие нового окна
            openNewWindow(tg.initDataUnsafe.user.id, profName.innerText);
        }

        if (document.readyState === 'complete') {
            // Если документ уже загружен, инициализируем Telegram немедленно
            initializeTelegram();
        } else {
            // Если документ еще загружается, добавляем слушатель события загрузки
            document.addEventListener('DOMContentLoaded', initializeTelegram);
        }
    </script>
</body>
</html>
